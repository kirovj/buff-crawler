<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="static/bootstrap.min.css">
    <script src="static/echarts.min.js"></script>
    <script src="static/jquery-3.6.0.slim.min.js"></script>
    <script src="static/bootstrap.min.js"></script>
</head>

<body>
    <br>
    <div id="chart" style="margin:auto; width: 1300px; height: 800px;"></div>
    <div id="search" style="width:100%;text-align:center">
        <form class="form-inline">
            <div class="form-group">
                <label for="searchName">Name</label>
                <input type="text" class="form-control" id="searchName" placeholder="蝴蝶刀">
            </div>
            <div class="form-group">
                <label for="searchTarget">Target</label>
                <input type="text" class="form-control" id="searchTarget" placeholder="buff">
            </div>
            <button type="button" class="btn btn-primary" id="searchButton">search</button>
        </form>
    </div>

    <br>
    <div style="margin:auto; width: 1300px;">
        <table id="table" class="table table-striped">
            <tbody>
                <tr>
                    <td>Name</td>
                    <td>Class</td>
                    <td>Ware</td>
                    <td>Quarty</td>
                    <td>Rarity</td>
                    <td>Stat_trak</td>
                </tr>
            </tbody>
        </table>
    </div>

    <script type="text/javascript">
        $("#searchButton").click(function () {
            var name = $("#searchName").val();
            var target = $("#searchTarget").val();
            window.fetch("/find_item", {
                method: 'post',
                body: JSON.stringify({
                    'target': target == '' ? $("#searchTarget").attr('placeholder') : target,
                    'name': name == '' ? $("#searchName").attr('placeholder') : name,
                    'item_id': 0
                }),
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            }).then(response => {
                if (response.ok) {
                    return response.json();
                }
            }).then(result => {
                var tb = document.getElementById("table");
                $('#table tr:not(:first)').html('');
                result['data'].forEach(data => {
                    var row = tb.insertRow(tb.FetchRowCount);
                    row.insertCell(0).innerHTML = data['name'];
                    row.insertCell(1).innerHTML = data['class'];
                    row.insertCell(2).innerHTML = data['ware'];
                    row.insertCell(3).innerHTML = data['quality'];
                    row.insertCell(4).innerHTML = data['rarity'];
                    row.insertCell(5).innerHTML = data['stat_trak'];
                });
            }).catch(error => {
                console.log(error);
            });
        });
    </script>

    <script type="text/javascript">
        // 基于准备好的dom，初始化echarts实例
        var chart = echarts.init(document.getElementById('chart'));

        window.fetch("/find_price", {
            method: 'post',
            body: JSON.stringify({
                'target': 'buff',
                'name': '蝴蝶刀',
                'item_id': 1220
            }),
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        }).then(response => {
            if (response.ok) {
                return response.json();
            }
        }).then(result => {
            console.log(result);
            var date_list = []
            var price_list = []
            result['data'].forEach(data => {
                date_list.push(data['date'].slice(2).replaceAll('-', '/'));
                price_list.push(data['price']);
            });

            // 计算数据最大值和最小值
            let minValue = 0
            let maxValue = 0
            let precision = 1 //精度
            maxValue = Math.ceil(Math.max.apply(null, price_list) / 10) * 10;
            minValue = Math.floor(Math.min.apply(null, price_list) / 10) * 10;
            // 计算间隔，返回y轴最大值，y轴最小值 ，间隔
            let getLeftData = (min, max) => {
                // 控制分隔条数，
                let diff = Math.ceil((max - min) / 3)
                return {
                    max: max + diff,
                    min: min - diff,
                    // 分割成 10 等份 
                    interval: Math.ceil((max + diff - (min - diff)) / 10),
                };
            }
            let interObj = getLeftData(minValue, maxValue)
            var option = {
                animationDuration: 500,
                title: {
                    text: 'CSGO ITEM PRICE'
                },
                tooltip: {},
                legend: {
                    data: ['price']
                },
                xAxis: {
                    data: date_list
                },
                yAxis: {
                    // 设置y轴间隔
                    interval: interObj.interval,
                    // 设置y轴最大值
                    min: interObj.min,
                    // 设置y轴最小值
                    max: interObj.max,
                    axisLabel: {
                        interval: 'auto',
                        formatter: function (value, index) {
                            return value;
                        }
                    },
                },
                series: [
                    {
                        name: 'price',
                        type: 'line',
                        smooth: true,
                        data: price_list
                    }
                ]
            };
            chart.setOption(option);
        }).catch(error => {
            console.log(error);
        });
    </script>
</body>

</html>